loaderå’ŒpluginåŒºåˆ«

## webpackç©¶ç«Ÿå¤„ç†ä»€ä¹ˆ

> å®˜æ–¹è§£é‡Šï¼š*webpack* æ˜¯ä¸€ä¸ªç°ä»£ JavaScript åº”ç”¨ç¨‹åºçš„*é™æ€æ¨¡å—æ‰“åŒ…å™¨(module bundler)*ã€‚å½“ webpack å¤„ç†åº”ç”¨ç¨‹åºæ—¶ï¼Œå®ƒä¼šé€’å½’åœ°æ„å»ºä¸€ä¸ª*ä¾èµ–å…³ç³»å›¾(dependency graph)*ï¼Œå…¶ä¸­åŒ…å«åº”ç”¨ç¨‹åºéœ€è¦çš„æ¯ä¸ªæ¨¡å—ï¼Œç„¶åå°†æ‰€æœ‰è¿™äº›æ¨¡å—æ‰“åŒ…æˆä¸€ä¸ªæˆ–å¤šä¸ª bundle

ç†è§£èµ·æ¥å°±æ˜¯ï¼š

1. ä»å…¥å£æ–‡ä»¶å¼€å§‹é€å±‚è¯†åˆ«æ¨¡å—ä¾èµ–
2. ç»è¿‡åˆ†æä»£ç ã€è½¬æ¢ä»£ç ã€ç¼–è¯‘ä»£ç ã€è¾“å‡ºä»£ç 
3. æœ€åè¾“å‡ºæ‰“åŒ…ä»£ç 



## ä»€ä¹ˆæ˜¯loader

>  å®˜ç½‘è§£æï¼šloaderç”¨äºå¯¹æ¨¡å—çš„æºä»£ç è¿›è¡Œè½¬æ¢ã€‚ç±»ä¼¼äºå…¶ä»–æ„å»ºå·¥å…·ä¸­çš„â€œä»»åŠ¡â€ï¼Œå¯ä»¥å°†æ–‡ä»¶ä»ä¸åŒçš„è¯­è¨€è½¬æ¢ä¸ºjsã€‚

loaderæ˜¯æ–‡ä»¶åŠ è½½å™¨ï¼Œèƒ½å¤ŸåŠ è½½èµ„æºæ–‡ä»¶ï¼Œå¹¶ä¸”å¯¹è¿™äº›æ–‡ä»¶è¿›è¡Œä¸€äº›å¤„ç†ï¼Œä¾‹å¦‚ç¼–è¯‘ã€å‹ç¼©ç­‰ï¼Œæœ€ç»ˆä¸€èµ·æ‰“åŒ…åˆ°æŒ‡å®šçš„æ–‡ä»¶ä¸­

1. å¤„ç†ä¸€ä¸ªæ–‡ä»¶å¯ä»¥ä½¿ç”¨å¤šä¸ªloaderï¼Œloaderçš„æ‰§è¡Œé¡ºåºå’Œé…ç½®ä¸­çš„é¡ºåºæ˜¯ç›¸åçš„ï¼Œå³æœ€åä¸€ä¸ªloaderæœ€å…ˆæ‰§è¡Œï¼Œç¬¬ä¸€ä¸ªloaderæœ€åæ‰§è¡Œã€‚
2. ç¬¬ä¸€ä¸ªæ‰§è¡Œçš„loaderæ¥æ”¶æºæ–‡ä»¶å†…å®¹æœ€ä¸ºå‚æ•°ï¼Œå…¶ä»–loaderæ¥æ”¶å‰ä¸€ä¸ªæ‰§è¡Œçš„loaderçš„è¿”å›å€¼ä½œä¸ºå‚æ•°ï¼Œæœ€åæ‰§è¡Œçš„loaderä¼šè¿”å›æ­¤æ¨¡å—çš„jsæºç 
3. loaderæœ¬è´¨å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ¥æ”¶æºæ–‡ä»¶ä¸ºå‚æ•°ï¼Œè¿”å›è½¬æ¢çš„ç»“æœã€‚



## ä»€ä¹ˆæ˜¯plugin

>  å®˜ç½‘è§£æ: pluginæ˜¯ä¸€ä¸ªå…·æœ‰applyå±æ€§çš„jså¯¹è±¡ï¼Œç›®çš„åœ¨äºè§£å†³loaderæ— æ³•è§£å†³çš„å…¶ä»–äº‹æƒ…ã€‚

åœ¨webpackè¿è¡Œçš„ç”Ÿå‘½å‘¨æœŸä¸­ä¼šå¹¿æ’­å¾ˆå¤šäº‹ä»¶ï¼Œpluginå¯ä»¥ç›‘å¬è¿™äº›äº‹ä»¶ï¼Œåœ¨åˆé€‚çš„æ—¶æœºé€šè¿‡webpackæä¾›çš„apiæ”¹å˜è¾“å‡ºç»“æœã€‚å¯ä»¥ç†è§£æˆåœ¨æ„å»ºæµç¨‹ä¸­æ³¨å…¥å„ç§é’©å­ã€‚



## ä¸ºä»€ä¹ˆä¼šå‡ºç°loaderã€plugin

webpackåªèƒ½å¤Ÿç†è§£jsã€jsonæ–‡ä»¶ï¼Œloaderå¯ä»¥è®©webpackèƒ½å¤Ÿå»å¤„ç†å…¶ä»–ç±»å‹çš„æ–‡ä»¶ï¼Œå¹¶è½¬æ¢æˆæœ‰æ•ˆæ¨¡å—ã€‚



## åŒºåˆ«æ˜¯ä»€ä¹ˆ

#### ä»è¿è¡Œæ—¶æœºçš„è§’åº¦æ¥åˆ†æ

1. loadeè¿è¡Œåœ¨æ‰“åŒ…æ–‡ä»¶ä¹‹å‰ï¼Œåœ¨æ¨¡å—åŠ è½½æ—¶çš„é¢„å¤„ç†ã€‚
2. pluginåœ¨æ•´ä¸ªç¼–è¯‘å‘¨æœŸéƒ½èƒ½å¤Ÿèµ·ä½œç”¨

#### ä»ä½œç”¨çš„è§’åº¦åˆ†æ

1. å¯¹äºloaderè€Œè¨€ï¼Œä»–æ˜¯ä¸€ä¸ªè½¬æ¢å™¨ï¼Œå°†Aæ–‡ä»¶è¿›è¡Œç¼–è¯‘ç”ŸæˆBæ–‡ä»¶ï¼Œè¿™é‡Œæ“ä½œçš„æ˜¯æ–‡ä»¶ï¼Œæ¯”å¦‚å°†A.scssè½¬æ¢æˆA.cssï¼Œæ˜¯ä¸€ä¸ªå•çº¯çš„æ–‡ä»¶è½¬æ¢è¿‡ç¨‹ã€‚
2. pluginæ˜¯ä¸€ä¸ªæ‰©å±•å™¨ï¼Œå®ƒä¸°å¯Œäº†webpackæœ¬èº«ï¼Œé’ˆå¯¹loaderç»“æŸåï¼Œwebpackæ‰“åŒ…çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œå¡”å¹¶ä¸ç›´æ¥æ“ä½œæ–‡ä»¶ï¼Œè€Œæ˜¯åŸºäºäº‹ä»¶æœºåˆ¶å·¥ä½œï¼Œå®ƒä¼šç›‘å¬webpackæ‰“åŒ…è¿‡ç¨‹ä¸­çš„æŸäº›èŠ‚ç‚¹ï¼Œæ‰§è¡Œå¹¿æ³›çš„ä»»åŠ¡ã€‚



## compilerå’ŒCompilation

#### Compiler æ˜¯ä»€ä¹ˆ

Compilerå¯¹è±¡åŒ…å«äº† Webpack ç¯å¢ƒæ‰€æœ‰çš„çš„é…ç½®ä¿¡æ¯ï¼ŒåŒ…å« optionsï¼Œloadersï¼Œplugins è¿™äº›ä¿¡æ¯ï¼Œè¿™ä¸ªå¯¹è±¡åœ¨ Webpack å¯åŠ¨æ—¶å€™è¢«å®ä¾‹åŒ–ï¼Œå®ƒæ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œå¯ä»¥ç®€å•åœ°æŠŠå®ƒç†è§£ä¸º Webpack å®ä¾‹ã€‚

#### Compilationæ˜¯ä»€ä¹ˆ

Compilation å¯¹è±¡åŒ…å«äº†å½“å‰çš„æ¨¡å—èµ„æºã€ç¼–è¯‘ç”Ÿæˆèµ„æºã€å˜åŒ–çš„æ–‡ä»¶ç­‰ã€‚å½“ Webpack ä»¥å¼€å‘æ¨¡å¼è¿è¡Œæ—¶ï¼Œæ¯å½“æ£€æµ‹åˆ°ä¸€ä¸ªæ–‡ä»¶å˜åŒ–ï¼Œä¸€æ¬¡æ–°çš„ Compilation å°†è¢«åˆ›å»ºã€‚Compilation å¯¹è±¡ä¹Ÿæä¾›äº†å¾ˆå¤šäº‹ä»¶å›è°ƒä¾›æ’ä»¶åšæ‰©å±•ã€‚é€šè¿‡ Compilation ä¹Ÿèƒ½è¯»å–åˆ° Compiler å¯¹è±¡ã€‚

#### åŒºåˆ«æ˜¯ä»€ä¹ˆ

Compiler ä»£è¡¨äº†æ•´ä¸ª Webpack ä»å¯åŠ¨åˆ°å…³é—­çš„ç”Ÿå‘½å‘¨æœŸï¼Œè€Œ Compilation åªæ˜¯ä»£è¡¨äº†ä¸€æ¬¡æ–°çš„ç¼–è¯‘ã€‚



## ä¸¾ä¸ªğŸŒ°

#### å†™ä¸€ä¸ªloader

ä¸‹é¢çš„è¿™ä¸ªloaderåšçš„ä¸€ä¸ªå¤„ç†å°±æ˜¯å°†txtæ–‡ä»¶æºç ä¸­çš„`[name]`æ›¿æ¢æˆwebpacké…ç½®ä¸­æ³¨å†Œè¯¥loaderæ—¶optionså®šä¹‰çš„nameã€‚

```js
// loader/replace-loader.js
// è¯¥å·¥å…·æ˜¯webpackæä¾›å‡ºæ¥çš„
const loaderUtils = require('loader-utils');

module.exports = function(source) {
    console.log('>>>>>replace-loaderå¤„ç†: ', source)
    // è·å–åˆ°ç”¨æˆ·ç»™å½“å‰ Loader ä¼ å…¥çš„ options
    const options = loaderUtils.getOptions(this);
    console.log({
        source,
        options,
    });
    // å°†æºæ–‡ä»¶ä¸­çš„[name]ä¿®æ”¹ä¸ºoptionsä¸­ä¼ å…¥çš„nameï¼Œè¿”å›js export
    source = source.replace(/\[name\]/g, options.name)
    return `export default ${JSON.stringify(source)}`;
}

// webpack.config.js
module.exports = {
  // ...çœç•¥ä¸€äº›é…ç½®
	module: {
      rules: [
          {
              test: /\.txt$/,
              use: [{
                  loader: 'replace-loader',
                  options: {
                    name: 'replace-loader'
                }
              }]
          }
      ]
  },
  // ResolveLoader ç”¨äºé…ç½® Webpack å¦‚ä½•å¯»æ‰¾ Loader
  // é»˜è®¤æƒ…å†µä¸‹åªä¼šå» node_modules ç›®å½•ä¸‹å¯»æ‰¾ï¼Œä¸ºäº†è®© Webpack åŠ è½½æ”¾åœ¨æœ¬åœ°é¡¹ç›®ä¸­çš„ Loader éœ€è¦ä¿®æ”¹ resolveLoader.modules
  resolveLoader: {
    // å»å“ªäº›ç›®å½•ä¸‹å¯»æ‰¾ Loaderï¼Œæœ‰å…ˆåé¡ºåºä¹‹åˆ†
    modules: [path.join(__dirname, '/loader')]
  },
}
```



#### ç¼–å†™ä¸€ä¸ªplugin

```js
// my-plugin.js
// pluginæ‰§è¡Œè¿‡ç¨‹ï¼Œå…ˆnewä¸€ä¸ªpluginå®ä¾‹å‡ºæ¥ï¼Œç„¶åä¼šé€šè¿‡
// compiler.pluginç›‘å¬åˆ°webpackå¹¿æ’­å‡ºæ¥çš„äº‹ä»¶ï¼Œå¹¶ä¸”å¯ä»¥
// é€šè¿‡compilerå¯¹è±¡å»æ“ä½œwebpack
class MyPlugin {
    constructor(options) {
        console.log('>>>>>MyPlugin Options', options);
    }
    apply(compiler) {
        // æ³¨å†Œæ’ä»¶
        compiler.hooks.run.tap('MyPlugin', compilation => {
            console.log("webpack æ„å»ºè¿‡ç¨‹å¼€å§‹ï¼");
        });
        compiler.plugin('emit', (compilation, callback) => {
            // ä¸‹é¢è¿™ä¸ªconsoleå¯ä»¥æ‰“å°å‡ºcompilationå¯¹è±¡ï¼Œè¯¥å¯¹è±¡å®é™…ä¸Šæ˜¯å½“å‰æ¨¡å—çš„èµ„æº
            // console.log('>>>>>emit æ¥æ”¶', compilation)
            console.log('>>>>>å½“å‰æ‰“åŒ…åçš„èµ„æº', compilation.assets)
            // æˆ‘å¯ä»¥åœ¨è¿™é‡Œå¯¹æ‰“åŒ…çš„èµ„æºåšäºŒæ¬¡åŠ å·¥
            // éå†æ‰“åŒ…åèµ„æº
            for (var filePathName in compilation.assets) {
                // å¦‚æœæ˜¯bundleæ–‡ä»¶
                if (/bundle/i.test(filePathName)) {
                    // å°†èµ„æºè¯»å–å‡ºæ¥
                    let content = compilation.assets[filePathName].source() || '';
                    // å°†copy-loaderé‡Œé¢çš„pluginNameæ›¿æ¢æˆæˆ‘è‡ªå·±çš„åå­—
                    content = content.replace('[pluginName]', 'å°å®æ˜¯çŒª');
                    // å°†ä¿®æ”¹åçš„èµ„æºæ›¿æ¢å›å»ï¼Œå…¶å®å°±æ˜¯é‡å†™æ–¹æ³•
                    compilation.assets[filePathName] = {
                        source () {
                          return content;
                        },
                        size () {
                          return content.length;
                        }
                    }
                }
            }
            // æ‰§è¡Œå›è°ƒ
            callback();
        });
    }
}
module.exports = MyPlugin;
```

è¿™ä¸ªæ’ä»¶çš„ä½œç”¨å°±æ˜¯å°†[pluginName]æ›¿æ¢æˆæƒ³è¦çš„å†…å®¹ã€‚

